# SOHOAAS Frontend Deployment (Cloud Run with Nginx Reverse Proxy)

This guide shows how to build the frontend Docker image, push it to Artifact Registry, deploy it to Cloud Run, and configure it to proxy API calls to the SOHOAAS backend running on Cloud Run.

The frontend uses Nginx as a reverse proxy with the following template:
- `app/frontend/nginx.conf.template` routes:
  - `/api/v1/**` → `${BACKEND_SERVICE_URL}/api/v1/**`
  - `/api/auth/**` → `${MCP_SERVICE_URL}/api/auth/**` (optional; only if you need browser-facing MCP OAuth)
- `app/frontend/docker-entrypoint.sh` substitutes `NGINX_PORT`, `BACKEND_SERVICE_URL`, and `MCP_SERVICE_URL` at runtime.

References:
- Dockerfile: `app/frontend/Dockerfile`
- Entrypoint: `app/frontend/docker-entrypoint.sh`
- Nginx template: `app/frontend/nginx.conf.template`

---

## 1) Prerequisites

- gcloud CLI installed and authenticated: `gcloud auth login`
- Project selected: `gcloud config set project <PROJECT_ID>`
- Enabled services:
  - Cloud Run: `gcloud services enable run.googleapis.com`
  - Artifact Registry: `gcloud services enable artifactregistry.googleapis.com`
- Artifact Registry repo created (substitute names as needed):
```bash
REGION="us-central1"
PROJECT_ID="sohoaas-dev"
REPO="mcp"

gcloud artifacts repositories create ${REPO} \
  --repository-format=docker \
  --location=${REGION} \
  --description="SOHOAAS containers" || true
```

---

## 2) Prepare frontend build-time env (Vite)

Vite reads build-time variables from `.env.production` (and other `.env.*` files). These are baked into the static build and are not Cloud Run runtime envs.

Create `app/frontend/.env.production` with your Firebase Web App config:
```ini
VITE_FIREBASE_API_KEY=...
VITE_FIREBASE_AUTH_DOMAIN=...
VITE_FIREBASE_PROJECT_ID=...
VITE_FIREBASE_STORAGE_BUCKET=...
VITE_FIREBASE_MESSAGING_SENDER_ID=...
VITE_FIREBASE_APP_ID=...
# If your code still references it (not required when proxying):
# VITE_BACKEND_URL=https://<your-backend-cloud-run-url>
```

Notes:
- If your frontend code uses relative `/api/...` calls, you do NOT need `VITE_BACKEND_URL`.
- Ensure your Firebase Hosting/Cloud Run frontend domain is added to Firebase Authentication → Authorized domains.

---

## 3) Build and push the frontend image

From the repo root:
```bash
REGION="us-central1"
PROJECT_ID="sohoaas-dev"
REPO="mcp"
IMAGE="frontend"
TAG="v1"

# Configure Docker to push to Artifact Registry
gcloud auth configure-docker ${REGION}-docker.pkg.dev

# Build: the Dockerfile runs `npm run build` inside the container, so .env.production must exist
docker build -t ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${IMAGE}:${TAG} app/frontend

# Push image
docker push ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${IMAGE}:${TAG}
```

---

## 4) Deploy to Cloud Run

Set the backend Cloud Run URL and deploy the frontend. Cloud Run injects `PORT` (8080); we map Nginx to listen on 8080 via `NGINX_PORT=8080`.

```bash
REGION="us-central1"
PROJECT_ID="sohoaas-dev"
REPO="mcp"
IMAGE="frontend"
TAG="v1"
BACKEND_URL="https://sohoaas-backend-958567825339.us-central1.run.app"   # Your backend Cloud Run URL
MCP_URL="https://mcp-backend-958567825339.us-central1.run.app"   # Your MCP Cloud Run URL

gcloud run deploy sohoaas-frontend \
  --image=${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${IMAGE}:${TAG} \
  --region=${REGION} \
  --platform=managed \
  --allow-unauthenticated \
  --port=8080 \
  --set-env-vars=NGINX_PORT=8080 \
  --set-env-vars=BACKEND_SERVICE_URL=${BACKEND_URL} \
  --cpu=1 --memory=512Mi

# Only if you still proxy browser-facing MCP OAuth:
# --set-env-vars=MCP_SERVICE_URL=https://<your-mcp-cloud-run-url>
```

Tip: If you need to update the backend URL later, you can run `gcloud run services update sohoaas-frontend --set-env-vars BACKEND_SERVICE_URL=... --region=${REGION}`.

---

## 5) Verify

Get the frontend Cloud Run URL from the deploy output or via:
```bash
gcloud run services describe sohoaas-frontend --region=${REGION} --format='value(status.url)'
```

- Frontend health check (served by Nginx):
```bash
curl -sS https://<frontend-run-url>/health
```
- Proxied backend health through the frontend:
```bash
curl -sS https://<frontend-run-url>/api/v1/health | jq
```
- Load the site and sign in with Firebase; API calls to `/api/v1/**` should succeed via the proxy.

---

## 6) Common troubleshooting

- "502 Bad Gateway" on `/api/v1/**`:
  - `BACKEND_SERVICE_URL` wrong or backend not publicly accessible.
  - Backend requires auth (e.g., Firebase ID token) — ensure the browser attaches valid Authorization headers.
- CORS errors:
  - With this reverse proxy, CORS should be avoided since requests originate from the frontend origin and Nginx forwards them. If you still see CORS in the browser devtools, verify requests go to `/api/v1/**` (not absolute URLs) and that Nginx forwards `Authorization` (`proxy_set_header Authorization $http_authorization;`).
- 404 on app routes:
  - SPA fallback is configured in `nginx.conf.template` via `try_files ... /index.html;`.
- Firebase sign-in blocked:
  - Add the frontend Cloud Run domain to Firebase Authentication → Authorized domains.
- Nginx port mismatch:
  - Cloud Run requires listening on `PORT` (8080). This guide sets `NGINX_PORT=8080`.

---

## 7) Optional hardening

- Restrict unauthenticated access: remove `--allow-unauthenticated` and put Cloud Armor/IAP or identity-aware access where appropriate.
- Set min instances for cold-start mitigation:
```bash
gcloud run services update sohoaas-frontend --region=${REGION} --min-instances=1
```
- Use custom domain + HTTPS: map your domain to the Cloud Run service in Cloud Console.

---

## 8) Quick rollback/update

- Update to a new image tag:
```bash
gcloud run deploy sohoaas-frontend \
  --image=${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${IMAGE}:v2 \
  --region=${REGION}
```
- Update only env var:
```bash
gcloud run services update sohoaas-frontend \
  --set-env-vars=BACKEND_SERVICE_URL=https://<new-backend-url> \
  --region=${REGION}
```

---

## 9) Summary

- Build-time: `.env.production` for Vite (Firebase config).
- Runtime: `BACKEND_SERVICE_URL` and `NGINX_PORT=8080` for the Nginx reverse proxy.
- Result: Frontend served by Cloud Run, `/api/v1/**` proxied to your SOHOAAS backend Cloud Run.
