# Backend Debugging Guide (Cloud Run + Local)

This guide shows how to debug the SOHOAAS backend like you do locally, including live log tailing, focused filters, and sanity checks for common 500s.

- Source files referenced:
  - `app/backend/internal/api/handlers.go`
  - `app/backend/internal/config/config.go`
  - `app/frontend/nginx.conf.template`

## Prerequisites
- `gcloud` CLI authenticated and configured.
- Cloud Run service name and region (defaults below):
  ```bash
  REGION=us-central1
  PROJECT_ID=sohoaas-dev
  SERVICE=sohoaas-backend
  ```

## Live log tail (like local Docker)
- Tail all logs:
  ```bash
  gcloud run services logs tail $SERVICE \
    --region $REGION --project $PROJECT_ID --follow
  ```

- Tail only errors:
  ```bash
  gcloud run services logs tail $SERVICE \
    --region $REGION --project $PROJECT_ID --follow \
    --severity=ERROR
  ```

- Tail Analyze Intent-specific errors:
  ```bash
  gcloud run services logs tail $SERVICE \
    --region $REGION --project $PROJECT_ID --follow \
    --filter='textPayload:"Failed to analyze intent" OR jsonPayload.message:"Failed to analyze intent"'
  ```

## One-off log queries
- Recent Analyze Intent errors (last hour):
  ```bash
  gcloud logging read \
    'resource.type="cloud_run_revision" AND resource.labels.service_name="sohoaas-backend" AND textPayload:"Failed to analyze intent"' \
    --project=$PROJECT_ID --freshness=1h --limit=50
  ```

- Only 5xx responses:
  ```bash
  gcloud logging read \
    'resource.type="cloud_run_revision" AND resource.labels.service_name="sohoaas-backend" AND httpRequest.status>=500' \
    --project=$PROJECT_ID --freshness=1h --limit=50
  ```

## Quick health checks
- Health:
  ```bash
  curl -i https://<cloud-run-backend>/api/v1/health
  ```

- Token presence (requires Firebase ID token; returns 200 if present, 401 if missing):
  - Handler: `GetTokenInfo()` in `handlers.go`
  ```bash
  curl -i -H "Authorization: Bearer <FIREBASE_ID_TOKEN>" \
    https://<cloud-run-backend>/api/v1/auth/token-info
  ```

- Validate MCP catalog availability:
  ```bash
  curl -i -H "Authorization: Bearer <FIREBASE_ID_TOKEN>" \
    https://<cloud-run-backend>/api/v1/validate/catalog
  ```
  If this fails, confirm `MCP_SERVICE_URL` is set correctly on Cloud Run and that the MCP backend is healthy.

## Analyze Intent test
- Minimal payload (replace token):
  ```bash
  curl -i -X POST https://<cloud-run-backend>/api/v1/intent/analyze \
    -H "Authorization: Bearer <FIREBASE_ID_TOKEN>" \
    -H "Content-Type: application/json" \
    -d '{"workflow_intent": {"WorkflowPattern":"test","TriggerConditions":{},"ActionSequence":[]}}'
  ```
  Correlate with `gcloud run services logs tail` output for detailed handler logs.

## Increase verbosity
- The backend reads `LOG_LEVEL` in `app/backend/internal/config/config.go`.
- To get logs similar to local (more `[DEBUG]` and `[AgentManager]` lines), redeploy with:
  ```bash
  --set-env-vars LOG_LEVEL=debug
  ```

## Common 500 causes checklist
- __OpenAI key missing__: Ensure secret `OPENAI_API_KEY` is set via `--set-secrets`.
- __MCP URL wrong/unreachable__: `MCP_SERVICE_URL` set to MCP Cloud Run URL (see `docs/10.BACKEND_DEPLOYMENT.md`).
- __Firebase auth header missing/invalid__: Ensure frontend includes `Authorization: Bearer <Firebase ID token>`.
- __Google token missing__: `GET /api/v1/auth/token-info` returns 401; user must re-connect Google.
- __CORS issues__: `nginx.conf.template` proxies `/api/v1/` and forwards `Authorization` header. Preflight should return 204 (as seen in logs).
- __Environment mismatch__: `GENKIT_ENV`, `ENVIRONMENT`, `LOG_LEVEL` consistent with expectations.

## Local vs Cloud Run parity
- Use the same `.env` values locally and on Cloud Run where possible.
- Verify proxy forwarding in `app/frontend/nginx.conf.template` for `/api/v1/` and `Authorization` header.
- When debugging auth flows, prefer calling the backend via the frontend proxy URL to match production behavior.

## Useful endpoints recap
- `GET /api/v1/health` – service health
- `GET /api/v1/auth/token-info` – Google token presence (200/401)
- `POST /api/v1/auth/store-google-token` – store Google token (proxy-first from frontend)
- `POST /api/v1/intent/analyze` – intent analysis flow
- `POST /api/v1/workflow/generate` – deterministic workflow generation
- `POST /api/v1/workflow/execute` – executes by stored `workflow_id`
- `GET /api/v1/validate/catalog` – MCP catalog validation

## Tips
- Always include the Firebase ID token when hitting protected endpoints.
- Use `--severity=ERROR` for quick triage, then tail full logs to see context before the error.
- If a restart clears in-memory Google tokens, the frontend now auto-logs out and prompts reconnection.
