# Backend → MCP OIDC Sidecar: Build & Deployment Guide

This guide shows how to run the backend with an OIDC-injecting sidecar so it can call the MCP Cloud Run service using the backend service account identity (no backend code changes).

Key paths:
- Sidecar source: `app/oidc-proxy/`
- Multi-container manifest: `deploy/backend-oidc-deployment.yaml`

## 1) Prerequisites
- gcloud SDK installed and authenticated: `gcloud auth login`
- Project and region set:
```bash
PROJECT_ID=sohoaas-dev
REGION=us-central1
REPO=mcp
BACKEND_IMG=${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/sohoaas-backend:poctag
PROXY_IMG=${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/oidc-proxy:poctag
MCP_URL=https://<your-mcp-service>  # e.g. https://mcp-backend-958567825339.us-central1.run.app
BACKEND_SA=backend-sa@${PROJECT_ID}.iam.gserviceaccount.com
STORAGE_BACKEND=gcs
GCS_BUCKET=sohoaas-workflows
GCS_PREFIX=workflows/
```
- Enable APIs (once per project):
```bash
gcloud services enable run.googleapis.com artifactregistry.googleapis.com iam.googleapis.com
```

## 2) Build and push images
- Backend image (if not already built/pushed for current tag):
```bash
# From repo root (or your backend build pipeline)
# Example only: ensure your backend container is built and pushed to $BACKEND_IMG
```
- OIDC proxy image:
```bash
cd app/oidc-proxy
gcloud auth configure-docker ${REGION}-docker.pkg.dev
docker build -t ${PROXY_IMG} .
docker push ${PROXY_IMG}
cd -
```

## 3) Lock MCP to only the backend service account (recommended)
```bash
gcloud run services add-iam-policy-binding mcp-backend \
  --region=${REGION} \
  --member=serviceAccount:${BACKEND_SA} \
  --role=roles/run.invoker
# Ensure MCP is not public (no allUsers invoker); require authentication on MCP.
```

## 4) Configure multi-container deployment
Edit `deploy/backend-oidc-deployment.yaml` and set:
- `spec.template.spec.serviceAccountName: ${BACKEND_SA}`
- Backend container `image: ${BACKEND_IMG}`
- Sidecar container `image: ${PROXY_IMG}`
- Backend env: `MCP_SERVICE_URL: http://localhost:8070`
- Sidecar env:
  - `LISTEN_ADDR: ":8070"`
  - `UPSTREAM_URL: ${MCP_URL}`
  - `AUDIENCE: ${MCP_URL}`
- Backend secrets (OPENAI + FIREBASE) already wired as env in the YAML

Example (excerpt):
```yaml
spec:
  template:
    spec:
      serviceAccountName: backend-sa@sohoaas-dev.iam.gserviceaccount.com
      containers:
      - name: backend
        image: us-central1-docker.pkg.dev/sohoaas-dev/mcp/sohoaas-backend:poctag
        env:
        - name: MCP_SERVICE_URL
          value: http://localhost:8070
      - name: oidc-proxy
        image: us-central1-docker.pkg.dev/sohoaas-dev/mcp/oidc-proxy:poctag
        env:
        - name: LISTEN_ADDR
          value: ":8070"
        - name: UPSTREAM_URL
          value: https://mcp-backend-958567825339.us-central1.run.app
        - name: AUDIENCE
          value: https://mcp-backend-958567825339.us-central1.run.app
```

## 5) Deploy multi-container service
```bash
gcloud run services replace deploy/backend-oidc-deployment.yaml --region=${REGION}
gcloud run services replace deploy/backend-oidc-deployment.yaml --region=us-central1 --platform=managed --project=sohoaas-dev
```
Notes:
- This replaces the service config with the YAML (recommended for multi-container).
- Ingress is currently `all`; keep backend app-level auth (Firebase) as in PoC.

## 6) Verify end-to-end
- Trigger any backend endpoint that makes an MCP call.
- MCP logs (Cloud Logging) should show successful authenticated requests from `${BACKEND_SA}`.
- If you see `401 Unauthorized` from MCP:
  - Check MCP `run.invoker` IAM includes `${BACKEND_SA}`
  - Confirm sidecar `AUDIENCE` exactly matches the MCP base URL
  - Ensure MCP is set to “require authentication” (not public)

## 7) Local development options
- Easiest (no IAM in dev):
  - Run MCP unauthenticated locally or use the public MCP; set backend `MCP_SERVICE_URL` directly to the MCP URL; skip sidecar.
- Test sidecar locally with SA key:
  - Create/download SA key with invoker on MCP:
    ```bash
    gcloud iam service-accounts keys create ~/sa-backend.json \
      --iam-account=${BACKEND_SA}
    export GOOGLE_APPLICATION_CREDENTIALS=~/sa-backend.json
    ```
  - Run the sidecar locally:
    ```bash
    cd app/oidc-proxy
    go run .
    # or docker run -e GOOGLE_APPLICATION_CREDENTIALS=/var/secrets/sa.json ...
    ```
  - Backend (local) points to `http://localhost:8070`.

## 8) Troubleshooting
- **401 from MCP**: invoker missing or audience mismatch.
- **token mint error** in sidecar logs: ADC not available (local) or metadata server unreachable (only happens outside Cloud Run); provide `GOOGLE_APPLICATION_CREDENTIALS` locally.
- **CORS/browser issues**: This path is backend→MCP only. Frontend→backend remains unchanged.
- **Performance**: Sidecar uses a short-lived token; optional optimization is to cache tokens for ~5 min. Current approach mints per request for simplicity.

## 9) Rollback
If needed, revert to single-container backend:
```bash
gcloud run services update sohoaas-backend \
  --image ${BACKEND_IMG} \
  --region ${REGION} \
  --set-env-vars MCP_SERVICE_URL=${MCP_URL}
```

---
With this setup, the MCP service can be restricted to only the backend service account, while the backend remains unchanged. The sidecar handles OIDC token injection transparently in Cloud Run and can be bypassed in local dev.
