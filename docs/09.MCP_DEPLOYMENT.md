# MCP Deployment Guide: Artifact Registry + Cloud Run

This guide describes how to build the MCP image, push it to Artifact Registry, and deploy it on Cloud Run for the PoC.

## Prerequisites

- gcloud CLI installed and authenticated.
- Project: `sohoaas-dev`.

```bash
gcloud auth login
gcloud config set project sohoaas-dev
```

## 1) Enable required APIs

```bash
gcloud services enable \
  artifactregistry.googleapis.com \
  cloudbuild.googleapis.com \
  run.googleapis.com
```

## 2) IAM (only if you hit PERMISSION_DENIED)

Grant your user minimal roles to build and deploy:

```bash
# Allow building
gcloud projects add-iam-policy-binding sohoaas-dev \
  --member="user:trifonov.dimitar@gmail.com" \
  --role="roles/cloudbuild.builds.editor"

# Allow deploying to Cloud Run
gcloud projects add-iam-policy-binding sohoaas-dev \
  --member="user:trifonov.dimitar@gmail.com" \
  --role="roles/run.admin"

gcloud projects add-iam-policy-binding sohoaas-dev \
  --member="user:trifonov.dimitar@gmail.com" \
  --role="roles/iam.serviceAccountUser"
```

Allow Cloud Build to push to Artifact Registry:

```bash
PROJECT_NUMBER=$(gcloud projects describe sohoaas-dev --format='value(projectNumber)')
gcloud projects add-iam-policy-binding sohoaas-dev \
  --member="serviceAccount:${PROJECT_NUMBER}@cloudbuild.gserviceaccount.com" \
  --role="roles/artifactregistry.writer"
```

## 3) Create Artifact Registry repository (once)

Use `us-central1` (Iowa) to match Cloud Run region.

```bash
gcloud artifacts repositories create mcp \
  --repository-format=docker \
  --location=us-central1 \
  --description="MCP images"
```

## 4) Build and push the MCP image

From the MCP backend directory (where `Dockerfile` is):

Directory: `mcp/server/backend/`

```bash
cd mcp/server/backend

gcloud builds submit \
  --tag us-central1-docker.pkg.dev/sohoaas-dev/mcp/service-proxies:poctag ./
```

Notes:
- Dockerfile builds a static binary and exposes port 8080.
- Healthcheck expects `GET /health`. Ensure the server serves that path, or update the Dockerfile healthcheck accordingly.

## 5) Deploy to Cloud Run

Deploy the pushed image:

```bash
gcloud run deploy mcp-backend \
  --image us-central1-docker.pkg.dev/sohoaas-dev/mcp/service-proxies:poctag \
  --region us-central1 \
  --platform managed \
  --allow-unauthenticated \
  --port 8080 \
  --set-env-vars LOG_LEVEL=info
```

Output will include a service URL, e.g.:

```
https://mcp-backend-XXXX-uc.a.run.app
```

### 5a) Provide env vars via Secret Manager (recommended)

Use Secret Manager to store sensitive values and inject them into Cloud Run as environment variables.

Enable the API:

```bash
gcloud services enable secretmanager.googleapis.com
```

Create secrets (one-time) with initial values:

```bash
printf '%s' 'your-client-id' | gcloud secrets create GOOGLE_CLIENT_ID \
  --replication-policy=automatic --data-file=-

printf '%s' 'your-client-secret' | gcloud secrets create GOOGLE_CLIENT_SECRET \
  --replication-policy=automatic --data-file=-

# Later rotation:
printf '%s' 'new-secret' | gcloud secrets versions add GOOGLE_CLIENT_SECRET --data-file=-
```

Grant the Cloud Run runtime service account access to read secrets:

```bash
PROJECT_NUMBER=$(gcloud projects describe sohoaas-dev --format='value(projectNumber)')
RUNTIME_SA="${PROJECT_NUMBER}-compute@developer.gserviceaccount.com"  # default runtime SA

gcloud projects add-iam-policy-binding sohoaas-dev \
  --member="serviceAccount:${RUNTIME_SA}" \
  --role="roles/secretmanager.secretAccessor"
```

Deploy and map secrets to env vars:

```bash
gcloud run deploy mcp-backend \
  --image us-central1-docker.pkg.dev/sohoaas-dev/mcp/service-proxies:poctag \
  --region us-central1 \
  --allow-unauthenticated \
  --port 8080 \
  --set-secrets GOOGLE_CLIENT_ID=GOOGLE_CLIENT_ID:latest \
  --set-secrets GOOGLE_CLIENT_SECRET=GOOGLE_CLIENT_SECRET:latest \
  --set-env-vars OAUTH_REDIRECT_URL=https://example.com/api/auth/google/callback \
  --set-env-vars LOG_LEVEL=info
```

Code usage:
- `mcp/server/backend/main.go` reads `os.Getenv("GOOGLE_CLIENT_ID")`, `os.Getenv("GOOGLE_CLIENT_SECRET")`, and `os.Getenv("OAUTH_REDIRECT_URL")`. No code changes needed.

## 6) Backend configuration

Set the backend to call this MCP URL:

- `MCP_SERVICE_URL=https://mcp-backend-XXXX-uc.a.run.app`

The backend method `MCPService.ExecuteAction()` at `app/backend/internal/services/mcp.go` will use this for `/api/mcp/tools/call`.

## 7) Smoke tests

- List tools:

```bash
curl -s https://mcp-backend-XXXX-uc.a.run.app/api/mcp/tools | jq '.tools | length'
```

- Call a tool directly (replace `<ACCESS_TOKEN>`):

```bash
curl -s -X POST https://mcp-backend-XXXX-uc.a.run.app/api/mcp/tools/call \
  -H 'Content-Type: application/json' \
  -d '{"name":"docs.create_document","arguments":{"token":"<ACCESS_TOKEN>","title":"PoC Doc"}}' | jq
```

## 8) Optional: Deploy from source (skip manual image push)

Cloud Run can build from source directly. From `mcp/server/backend/`:

```bash
gcloud run deploy mcp-backend \
  --source . \
  --region us-central1 \
  --allow-unauthenticated \
  --port 8080 \
  --set-env-vars LOG_LEVEL=info
```

## 9) Troubleshooting

- PERMISSION_DENIED on builds: add IAM roles in step 2.
- Artifact Registry not found: ensure repo exists in step 3; region matches Cloud Run.
- Healthcheck failing: confirm your server exposes `/health`, or adjust the Dockerfile `HEALTHCHECK` path.
- 404/401 from tools/call: verify token validity, tool name (`gmail.send_message`, `docs.create_document`, `drive.share_file`, `calendar.create_event`), and arguments.
