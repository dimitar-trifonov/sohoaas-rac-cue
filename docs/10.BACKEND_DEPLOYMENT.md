# SOHOAAS Backend Deployment Guide (Cloud Run)

This guide shows how to build the backend image, push it to Artifact Registry, configure secrets, and deploy to Cloud Run.

## Prerequisites

- gcloud CLI installed and authenticated.
- Project: `sohoaas-dev`.
- Region: `us-central1`.

```bash
gcloud auth login
gcloud config set project sohoaas-dev
```

## 1) Enable required APIs

```bash
gcloud services enable \
  artifactregistry.googleapis.com \
  cloudbuild.googleapis.com \
  run.googleapis.com \
  secretmanager.googleapis.com
```

## 2) Create Artifact Registry repository (once)

```bash
gcloud artifacts repositories create mcp \
  --repository-format=docker \
  --location=us-central1 \
  --description="SOHOAAS images"
```

If it already exists, you can skip this.

## 3) Build the backend image and push to Artifact Registry

Important: Build context must be the repo root (`sohoaas/`) because the Dockerfile copies `./app/backend/...` and `./rac/...`.

```bash
PROJECT_ID=sohoaas-dev
REGION=us-central1
AR_HOST=${REGION}-docker.pkg.dev
REPO=mcp
IMAGE=sohoaas-backend
TAG=poctag
FULL_IMAGE="${AR_HOST}/${PROJECT_ID}/${REPO}/${IMAGE}:${TAG}"

# Configure Docker to push to Artifact Registry
gcloud auth configure-docker ${AR_HOST}

# From repo root
docker build -f app/backend/Dockerfile -t "${FULL_IMAGE}" .

docker push "${FULL_IMAGE}"
```

Alternatively, you can have Cloud Build build and push:

```bash
# From repo root
gcloud builds submit \
  --tag ${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPO}/${IMAGE}:${TAG} \
  ./app/backend
```

## 4) Create and load secrets (Secret Manager)

Required by `app/backend/internal/services/firebase_auth.go` and `internal/config/config.go`:
- `FIREBASE_PROJECT_ID` (string)
- `FIREBASE_PRIVATE_KEY` (multi-line PEM; store raw, with real newlines)
- `FIREBASE_CLIENT_EMAIL` (service account email)
- `OPENAI_API_KEY` (optional but recommended)

Create secrets (one-time). Paste the private key with real newlines (no `\n`).

```bash
printf '%s' 'sohoaas-dev' | gcloud secrets create FIREBASE_PROJECT_ID \
  --replication-policy=automatic --data-file=-

cat <<'EOF' | gcloud secrets create FIREBASE_PRIVATE_KEY --replication-policy=automatic --data-file=-
-----BEGIN PRIVATE KEY-----
<paste your key here with real newlines>
-----END PRIVATE KEY-----
EOF

printf '%s' 'firebase-adminsdk-xyz@sohoaas-dev.iam.gserviceaccount.com' |
  gcloud secrets create FIREBASE_CLIENT_EMAIL --replication-policy=automatic --data-file=-

printf '%s' 'sk-...' | gcloud secrets create OPENAI_API_KEY \
  --replication-policy=automatic --data-file=-
```

For rotation later:

```bash
printf '%s' 'new-value' | gcloud secrets versions add OPENAI_API_KEY --data-file=-
```

## 5) Grant Cloud Run runtime access to secrets

```bash
PROJECT_NUMBER=$(gcloud projects describe sohoaas-dev --format='value(projectNumber)')
RUNTIME_SA="${PROJECT_NUMBER}-compute@developer.gserviceaccount.com"  # default runtime SA

gcloud projects add-iam-policy-binding sohoaas-dev \
  --member="serviceAccount:${RUNTIME_SA}" \
  --role="roles/secretmanager.secretAccessor"
```

(Optional) Use a custom service account and grant it the same role, then deploy with `--service-account`.

## 6) Deploy to Cloud Run

Backend reads config from envs in `app/backend/internal/config/config.go`.
- Required secrets are mapped to env vars with `--set-secrets`.
- `MCP_SERVICE_URL` must point to the MCP service URL (from MCP deploy), e.g. `https://mcp-backend-958567825339.us-central1.run.app`.

```bash
REGION=us-central1
PROJECT_ID=sohoaas-dev
AR_HOST=${REGION}-docker.pkg.dev
REPO=mcp
IMAGE=sohoaas-backend
TAG=poctag
FULL_IMAGE="${AR_HOST}/${PROJECT_ID}/${REPO}/${IMAGE}:${TAG}"

gcloud run deploy sohoaas-backend \
  --image "${FULL_IMAGE}" \
  --region "${REGION}" \
  --allow-unauthenticated \
  --port 8080 \
  --set-secrets OPENAI_API_KEY=OPENAI_API_KEY:latest \
  --set-secrets FIREBASE_PROJECT_ID=FIREBASE_PROJECT_ID:latest \
  --set-secrets FIREBASE_PRIVATE_KEY=FIREBASE_PRIVATE_KEY:latest \
  --set-secrets FIREBASE_CLIENT_EMAIL=FIREBASE_CLIENT_EMAIL:latest \
  --set-env-vars MCP_SERVICE_URL=https://mcp-backend-958567825339.us-central1.run.app,ENVIRONMENT=production,LOG_LEVEL=info,GENKIT_ENV=production,STORAGE_BACKEND=gcs,GCS_BUCKET=sohoaas-workflows,GCS_PREFIX=workflows/
```

Notes:
- Cloud Run injects `PORT`; the server reads it via `config.New()` → `cfg.Port` (default 8080).
- The Dockerfile exposes `8081`, but Cloud Run will pass `PORT=8080`. The app binds to the provided `PORT`.

### Optional: Storage backend (GCS) [planned]

The current backend does not yet read `STORAGE_BACKEND`/`GCS_*` envs. If you want to prepare flags for a future GCS storage implementation, you can include them (no effect until code is added):

```bash
gcloud run deploy sohoaas-backend \
  --image "${FULL_IMAGE}" \
  --region "${REGION}" \
  --allow-unauthenticated \
  --port 8080 \
  --set-secrets OPENAI_API_KEY=OPENAI_API_KEY:latest \
  --set-secrets FIREBASE_PROJECT_ID=FIREBASE_PROJECT_ID:latest \
  --set-secrets FIREBASE_PRIVATE_KEY=FIREBASE_PRIVATE_KEY:latest \
  --set-secrets FIREBASE_CLIENT_EMAIL=FIREBASE_CLIENT_EMAIL:latest \
  --set-env-vars MCP_SERVICE_URL=https://mcp-backend-958567825339.us-central1.run.app,ENVIRONMENT=production,LOG_LEVEL=info,GENKIT_ENV=production,STORAGE_BACKEND=gcs,GCS_BUCKET=sohoaas-workflows,GCS_PREFIX=workflows/
```

IAM (when implemented): deploy with a dedicated service account that has `roles/storage.objectAdmin` on the target bucket, e.g. `--service-account sohoaas-run@sohoaas-dev.iam.gserviceaccount.com`.

## 7) Verify deployment

Get the service URL from the deploy output, then:

```bash
# Health
curl -sSf https://<backend-service-url>/api/v1/health | jq

# (Optional) List services (might require auth depending on middleware)
curl -sSf https://<backend-service-url>/api/v1/services | jq

# Authenticated: list services with ID token
ID_TOKEN="<your Firebase ID token>"
curl -sSf https://<backend-service-url>/api/v1/services \
  -H "Authorization: Bearer ${ID_TOKEN}" | jq

# Authenticated: execute a stored workflow by ID
curl -sSf -X POST https://<backend-service-url>/api/v1/workflows/execute \
  -H "Authorization: Bearer ${ID_TOKEN}" \
  -H "Content-Type: application/json" \
  -d '{
    "workflow_id": "<your-workflow-id>",
    "user_parameters": {
      "example_param": "value"
    }
  }' | jq
```

## 8) Troubleshooting

- Startup failure: Check logs for init errors (often Firebase envs or secrets access).
```bash
gcloud logs read \
  'resource.type="cloud_run_revision" AND resource.labels.service_name="sohoaas-backend"' \
  --project sohoaas-dev --limit 200 --format='value(textPayload)'
```
- Error like `no private key data found`: ensure `FIREBASE_PRIVATE_KEY` secret stores the raw multi-line PEM (no `\n`). Re-add a new version with real newlines.
- 401 on protected endpoints: authentication middleware requires valid Firebase ID token.
- Update image: push new tag and redeploy with the same commands.

## References in code
- Server entry: `app/backend/main.go` — binds to `PORT`, sets up routes, initializes services.
- Config: `app/backend/internal/config/config.go` — reads env vars (`MCP_SERVICE_URL`, `OPENAI_API_KEY`, `GOOGLE_*`, etc.).
- Firebase auth: `app/backend/internal/services/firebase_auth.go` — requires `FIREBASE_PROJECT_ID`, `FIREBASE_PRIVATE_KEY`, `FIREBASE_CLIENT_EMAIL`.
